<html>

<head>
<meta http-equiv="Content-Language" content="en-us">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>EPICS Save</title>
</head>

<body>

<p align="center"><font size="4"><b>EPICS Save/Restore (sr) Upgrade Project</b></font></p>
<p align="center"><font size="4"><b>(Channel Watcher)</b></font></p>
<ul>
<li><a href="#Staged Implementation">Staged Implementation</a></li>
<li><a href="#File Formats">Master and Channel Group File Formats</a></li>
<li><a href="#How to Start Channel Watcher">How to Start Channel Watcher</a></li>
<li><a href="index.html">Software Distribution Page</a></li>
</ul>

<p align="left"><b>Problem: </b>The current version of Save/Restore (sr), also
known as Bumpless Reboot, may be
interfering with normal IOC operations due to the large number of file writes.</p>
<p align="left"><b>Solution: </b>Move the file writes (i.e. <i>Save</i> functions) to a client computer (i.e. UNIX box).&nbsp; We may even eventually do away with
the file altogether and use a database such as Oracle.&nbsp; Leave the restore
functions on the IOC.</p>
<p align="left"><b>Notes from the EPICS Workshop, Dec. 3&amp;4, 2001, Fairmont
Hotel, San Jose: </b>Jeff Hill suggests that we design the software with Object
Oriented Plug-ins so users can choose which features to include in their local
Channel Watcher builds.&nbsp; Click <a href="ChannelWatcher_design.html">here</a>
for software design notes.</p>
<p><b><a NAME="Staged Implementation"></a>Staged Implementation:</b></p>
<p>The software upgrade will be developed in the following stages.&nbsp; Each
stage represents a point at which the software will be tested and released.</p>
<p><i>Stage 1: Simple move to UNIX with enhancements</i></p>
<blockquote>
  <p><a href="ChannelWatcherStage1.gif"><img border="0" src="ChannelWatcherStage1.gif" alt="Channel Watcher Stage 1" width="575" height="324"></a></p>
  <p><i>Stage 1 Enhancements:</i></p>
  <ul>
    <li>Toggle channel logging on the fly</li>
    <li>Add and Remove channels on the fly</li>
    <li><i><b>/nowrite </b></i>option for logging only and toggle it on the fly.&nbsp;
      Channels with the <i>/nowire </i>option do not cause the Restore Repository
      to be generated.</li>
    <li>Don't write <i>unknown </i>values to Repository for when Channel
      Watcher can't connect to IOC, like when it's down</li>
    <li>Allow other Channel Groups inside the Channel Group (i.e. <i>Masterfile</i>).</li>
    <li>Web documentation</li>
    <li>Put Channel Groups and the Master Files in AFS and manage using
      CVS.&nbsp; Manually FTP or SCP files to the gateway /usr/local area 
      after a change.</li>
    <li>Add a channel alias name which will be supplied as a comment next to the
      channel name in some Channel Group files.</li>
    <li>Put Repositories in the /u1 area (different from the area for the
      Channel Groups) where they will be backed up every night.&nbsp; Each
      Repository may be in a different directory so if a Master File is
      used, it must specify the Channel Group file name, with path, and the path
      and name of the Repository created for it.</li>
    <li>Write Repository on any channel value change, but no more than every
      <i>configurable</i> seconds.&nbsp; See <i>-t</i> option on startup.</li>
    <li>Repository files need to have owner and group write privilege</li>
    <li>Write Repositories in s/r version V1.91 format.&nbsp; This format is
      in ascii because it is easily editable by somebody making a software
      release who needs the IOC to reboot with different values.</li>
    <li>Remove check for string of nulls.</li>
    <li>Create a <i>health summary </i>EPICS Record and additional CWlog messages when this
      record goes into alarm state.&nbsp;&nbsp;Record names are <i> CS02:CWPEPII:SUMY:STAT </i> and <i> CS02:CWNLCTA:SUMY:STAT
      </i>(not yet available).&nbsp;<i>&nbsp; </i><b>mbbo </b>enum values are:
      <ul>
        <li>0 = OK</li>
        <li>1 = DOWN</li>
        <li>2 = HUNG</li>
        <li>3 = CONNERR</li>
        <li>4 = DISKERR</li>
        <li>probably others up to 15</li>
      </ul>
    </li>
  <li>Don't tie Channel Watcher to a specific file system such as afs or nfs.</li>
  <li>Save/Restore source is located in $EPICS/site/src/saverestore/sr-pepii</li>
  <li>Channel Watcher is run on 
      <a href="http://www.slac.stanford.edu/grp/cd/soft/pepii/slaconly/network/opi/index.html">opi(s)</a> 
      (CS02 initially) from the 
      <a href="http://www.slac.stanford.edu/grp/cd/soft/pepii/slaconly/shared_accounts/index.html">shared account</a> 
      used for starting standalones</li>
  <li>If, for some reason, the Channel Watcher is prone to crashing, make cron job that will execute every 5 minutes and restart any missing
    Channel Watcher process (we may have one cron job per Channel Watcher process if that's better).</li>
    <li><b>Test Plan:</b> In order to ensure the Channel Watcher is properly running we plan on&nbsp;
running it in parallel with the current Save/Restore software on the IOC, using
different Repositories, of course, and comparing the Repositories generated by both.&nbsp;
      When we're satisfied Channel Watcher works we'll need to add Channel
      Watcher to the UNIX startup files and remove the <i>create_monitor_sets</i>
      from IOC startup.</li>
  </ul>
  <p>The following tags may be used in CWlog messages:</p>
  <div align="center">
    <center>
    <table border="1" width="67%">
      <tr>
        <td width="15%"><b>Tag</b></td>
        <td width="85%"><b>Value</b></td>
      </tr>
      <tr>
        <td width="15%">text</td>
        <td width="85%">text of message like what epicsPrintf provides</td>
      </tr>
      <tr>
        <td width="15%">facility</td>
        <td width="85%">Channel Watcher</td>
      </tr>
      <tr>
        <td width="15%">host</td>
        <td width="85%">IOC associated with the channel</td>
      </tr>
      <tr>
        <td width="15%">device</td>
        <td width="85%">Channel Name</td>
      </tr>
      <tr>
        <td width="15%">message</td>
        <td width="85%">Channel alias</td>
      </tr>
      <tr>
        <td width="15%">severity</td>
        <td width="85%">EPICS severity of the channel</td>
      </tr>
      <tr>
        <td width="15%">status</td>
        <td width="85%">EPICS status of the channel</td>
      </tr>
      <tr>
        <td width="15%">value</td>
        <td width="85%">Current value of the channel as a string</td>
      </tr>
      <tr>
        <td width="15%">code</td>
        <td width="85%">See Channel Watcher file CWlogmsgABC.hh for a list of codes</td>
      </tr>
    </table>
    </center>
  </div>
</blockquote>
<p><i>Stage 2: Convert Repositories to caGet/caPut file format and add cmlog
message Throttling.</i></p>
<ul>
  <li>Channel Watcher will write Repositories using the same format as the
    caPut2 function. Example 
    caPut2 file is in $BIC_DATA/save_restore/BIC_gold.sav.&nbsp;
    Source for caPut2 is in $EPICS/extensions/src/caSlac/caPut2.c</li>
  <li>Glen - Add comment lines to the caGet/caPut file format.</li>
  <li>Glen - Convert caGet/caPut file format to use native EPICS data type.</li>
  <li>Glen - Add waveform records to caGet/caPut file.</li>
  <li>Save/Restore's <i>fdbrestore</i> and <i>reboot_restore</i> need to restore
    enums by native data type.</li>
  <li>CWget and CWput to replace caGet and caPut.&nbsp; These two are compiled
    and linked with the same options at the Channel Watcher.</li>
</ul>
<p><i>Stage 3: Statistics</i></p>
<blockquote>
  <p>Web interface to list channels by</p>
  <ul>
    <li>Active Channel Group&nbsp;</li>
    <li>          Clickable Inactive Channel Group files just like windows does&nbsp;</li>
    <li>          IOC&nbsp;</li>
    <li>          Alphabetically&nbsp;</li>
    <li>          How often channels are changing and flag channels changing faster than some max rate that we can change on the fly.&nbsp;
      Even have a different max update rate per channel and a list of channels
      by max update rate.</li>
    <li>          Time of last change&nbsp;</li>
    <li>          Which channels are not connected (just like the Channel Archiver)&nbsp;</li>
  </ul>
</blockquote>
<p><i>Stage 4: Wildcarding using regular expressions</i></p>
<blockquote>
<p>Add wildcarding of channel names in the Channel Groups and to the Statistics tool listed above using the same
Oracle
Database we now know and love.&nbsp; Steph says that there are epics library
tools that already know how to resolve regular expressions.</p>
<p>As long as we're doing that Kristi wants the software designed in such a way
as to make it easy to make a tool that will list channels given a regular
expression.&nbsp; Make it and call it <b>ChannelLister.</b></p>
</blockquote>
<p><i>Stage 5: Channel Groups and Repositories in Oracle Database</i></p>
<blockquote>
<p><a href="ChannelWatcherStage5.gif"><img border="0" src="ChannelWatcherStage5.gif" alt="Channel Watcher Stage 5" width="655" height="337"></a></p>
  <p><i>Stage 5 Enhancements:</i></p>
  <ul>
    <li>Real on the fly toggling of <i>/log, /nowrite,&nbsp;</i> <i>add/remove
      channel, </i>and <i>maximum update rate on a per channel basis </i>with
      messages to CWlog.&nbsp; Make sure to allow wildcarding with regular
      expressions.</li>
    <li>GUI replaces Channel Groups in files</li>
    <li>Channel values written to Oracle Database, but file Repositories still
      generated.</li>
    <li>Channels with <i>/nowrite </i>should not update the Oracle Database.</li>
    <li>On demand save via a button push that allows different file names for
      the Repository, but the <i>Bumpless Reboot </i>functionality still generates the
      Repository on value change</li>
    <li>CGI scripts in Perl for web interface to data stored in Oracle</li>
  </ul>
  <p>.</p>
</blockquote>
<p><i>Stage 6: Restore from Oracle Database</i></p>
<blockquote>
<p><a href="ChannelWatcherStage7.gif"><img border="0" src="ChannelWatcherStage7.gif" alt="Channel Watcher Stage 7" width="622" height="228"></a></p>
<p>Instead of reading the file Repositories the&nbsp; IOC could get the channel values
  directly from the Oracle Database possibly with Aida.&nbsp; Steph also points
out that at this point the Channel Watcher <i>could </i>run on an IOC so make
sure the code is generic enough so that it can run on multiple platforms.</p>
</blockquote>
<hr>
<p><b><a NAME="File Formats"></a>Master File Format:</b></p>
<blockquote>
<p>Channel-Group-file-name <u>&lt;<i>white</i>  <i>space&gt;
Repository_file_name </i></u></p>
  <p><b>Master File Notes:&nbsp;</b></p>
  <ul>
    <li>Optional items are <u>underlined.</u>&nbsp;&nbsp;</li>
    <li>Repository file name defaults to Channel-Group-file-name<i>.sav</i></li>
    <li>Allow macros in the above file names and use the epics macro library.</li>
    <li>Make sure Channel Group file names don't recurse.</li>
  </ul>
</blockquote>
<p><b>Channel Group File Format: </b><i>optional items in italics</i></p>
<blockquote>
  <p><i># comment</i></p>
  <p>channel:name <i>&lt;white space&gt; /log &lt;white space&gt; /nowrite
  &lt;white space&gt; # &lt;white space&gt; channel:alias</i></p>
  <p>channel:name <i>&lt;white space&gt; /LOG &lt;white space&gt; /NOWRITE
  &lt;white space&gt; # &lt;white space&gt; channel:alias</i></p>
  <p><i>&lt;blank lines&gt;</i></p>
</blockquote>
<p><b><a NAME="How to Start Channel Watcher"></a>How to start the Channel Watcher:</b></p>
<blockquote>
The startup procedure and file locations for PEPII and NLC development channel 
watcher processes are detailed in these SLAC-only links:
  <p><a href="http://www.slac.stanford.edu/grp/cd/soft/share/slaconly/ChannelWatcher/pepii.html">
     PEPII IOCS (except LLRF)</a>
  <br><a href="http://www.slac.stanford.edu/grp/cd/soft/share/slaconly/ChannelWatcher/p2rf.html">
     PEPII LLRF IOCs</a>
  <br><a href="http://www.slac.stanford.edu/grp/cd/soft/share/slaconly/ChannelWatcher/nlcta.html">
     NLCTA RF IOCs</a>
  <br><a href="http://www.slac.stanford.edu/grp/cd/soft/share/slaconly/ChannelWatcher/dev.html">
     Development</a>
  <br><a href="http://www.slac.stanford.edu/~spear/epics/slaconly/cw">
     SPEAR</a></p>
  <p><b>Options for starting channel watcher:</b></p>
</blockquote>
<div align="center">
  <center>
  <table border="1" width="694" height="9">
    <tr>
      <td width="38" height="12">-f</td>
      <td width="1021" height="12">specifies the Channel Group file name or
        Master File name</td>
      <td width="924" height="12">required</td>
    </tr>
    <tr>
      <td width="38" height="12">-s</td>
      <td width="1021" height="12">specifies the Repository Name</td>
      <td width="924" height="12">optional, defaults to Channel Group File name <i>.sav</i></td>
    </tr>
    <tr>
      <td width="38" height="12">-c</td>
      <td width="1021" height="12">specifies the top of the Channel Group location. Overwrites
        CW_CHANNEL_GROUP_ROOT</td>
      <td width="924" height="12">optional</td>
    </tr>
    <tr>
      <td width="38" height="9">-r</td>
      <td width="1021" height="9">specifies the top of the Repository
        location.&nbsp; Overwrites CW_REPOSITORY_ROOT</td>
      <td width="924" height="9">optional, but -r requires -c</td>
    </tr>
    <tr>
      <td width="38" height="12">-t</td>
      <td width="1021" height="12">specifies the minimum time required between
        Repository generations</td>
      <td width="924" height="12">optional, default to 10 seconds.&nbsp; Must be &gt;= 10
        seconds.</td>
    </tr>
    <tr>
      <td width="38" height="12">-l</td>
      <td width="1021" height="12">specifies the location
        of any non-Repository file written by Channel Watcher (like a log
        file) overwrites stderr</td>
      <td width="924" height="12">optional, defaults to stderr</td>
    </tr>
    <tr>
      <td width="38" height="12">-n</td>
      <td width="1021" height="12">specifies the maximum number of cmlog
        messages to issue in -m seconds before throttling for a channel</td>
      <td width="924" height="12">optional, defaults to 4 messages</td>
    </tr>
    <tr>
      <td width="38" height="12">-m</td>
      <td width="1021" height="12">specifies the minimum time required between
        cmlog messages for a channel before throttling</td>
      <td width="924" height="12">optional, defaults to 10 seconds</td>
    </tr>
    <tr>
      <td width="38" height="12">-e</td>
      <td width="1021" height="12">specifies ca_pend_event time in seconds</td>
      <td width="924" height="12">optional, defaults to 1, must be less than or
        equal to -t and -m</td>
    </tr>
    <tr>
      <td width="38" height="12">-i</td>
      <td width="1021" height="12">specifies and identifying tag for log
        messages.&nbsp; Useful when running more than one Channel Watcher.</td>
      <td width="924" height="12">optional, defaults to NULL</td>
    </tr>
    <tr>
      <td width="38" height="12">-h</td>
      <td width="1021" height="12">help</td>
      <td width="924" height="12">optional</td>
    </tr>
    <tr>
      <td width="38" height="12">-p</td>
      <td width="1021" height="12">Health Summary PV name</td>
      <td width="924" height="12">optional</td>
    </tr>
  </table>
  </center>
</div>
<blockquote>
<p><b>Environment variables used by Channel Watcher:</b></p>
<ul>
  <li>CW_CHANNEL_GROUP_ROOT - optional.&nbsp; Specifies the top of the
    Channel Group location.</li>
  <li>CW_REPOSITORY_ROOT - optional.&nbsp; Specifies the top of the
    Repository location.</li>
</ul>
</blockquote>
<p><b>Notes:</b></p>
<ul>
  <li><a href="http://www.slac.stanford.edu/grp/cd/soft/share/slaconly/ChannelWatcher/ChannelWatcher_migration.html">SLAC migration notes.</a>&nbsp;</li>
  <li>Where does Oracle Database live?&nbsp; Ron suggests gateway, but Oracle
    isn't installed on the gateway and Jingchen doesn't want it there at least
    until we're on a more open network.</li>
  <li>What GUI did we decide on for Stage 3?&nbsp; Perl with CGI.</li>
  <li>How does the current sr restore enums?&nbsp; By string or by value?&nbsp;
    Both are present in the Repositories.&nbsp; You're not gonna like this: <i>fdbrestore
    </i> uses the string; the first value that's between the ctrl-A terminators.&nbsp;
    <i>reboot_restore</i> uses the number; the second value that's between the second ctrl-A terminator and
    eol.</li>
  <li>Steph knows how to add the Channel Watcher to the (SLC?) network display.</li>
  <li>Bob Hall and Jingchen know how to manage Channel Watcher tasks with a cron job.</li>
  <li>Where are channel access routines described?&nbsp; <a href="http://lansce.lanl.gov/lansce8/Epics/ca/ca.htm">http://lansce.lanl.gov/lansce8/Epics/ca/ca.htm</a></li>
</ul>
<p><b>Definitions:</b></p>
<ul>
  <li><a href="http://www.slac.stanford.edu/grp/cd/soft/slaconly/req/glossary.html">SLAC
    ESD Glossary</a></li>
  <li><b>Channel Groups - </b>User created files, usually by an editor, list of
    epics channels for sr and now Channel Watcher.&nbsp; This is the only file
    not automatically generated.</li>
  <li><font size="3"><b>Channel Watcher - </b>Replaces save/restore
    &quot;save&quot; part by migrating its functions to UNIX.</font></li>
  <li><b>Common Message Logger - </b>EPICS extension Channel Watcher may use to
    report errors or channel value changes when logging is requested.&nbsp; Also
    known as <i>cmlog.</i>&nbsp;</li>
  <li><b>On the Fly - </b>For Stage 1 implementation this means: edit your
    channel list file then restart the Channel Watcher.&nbsp; For stage 4
    implementation this will be done with a GUI and message passing.</li>
  <li><font size="3"><b>Repository - </b></font>Files automatically generated
    by sr and Channel Watcher that the <i>restore</i> functions <i>reboot_restore</i>
    and <i>fdbrestore </i>need in order to restore channel values on IOC reboot.
    A repository may contain 3 different files:&nbsp;
    <ul>
      <li><i>ChannelGroup.sav - </i>Last successful Repository written</li>
      <li><i>ChannelGroup.sav.bu - </i>Repository from Last IOC boot</li>
      <li><i>ChannelGroup.sav.next - </i>Current working file.&nbsp; This
        file may become the <i>.sav </i>file if it passes all validity checks.</li>
    </ul>
  </li>
  <li><font size="3"><b>Save Restore (sr) - </b></font>A way to save and restore
    epics channels on an IOC. Also known as <i>Bumpless Reboot.</i></li>
</ul>
<p><i>Last Update 10-Oct-2002 by Mike Zelazny <a href="mailto:zelazny@slac.stanford.edu">zelazny@slac.stanford.edu</a></i></p>
<p>&nbsp;</p>
<p>&nbsp;</p>

</body>

</html>
