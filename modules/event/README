Instructions for RTEMS EVR users                    Last Updated 01/12/2009
--------------------------------

I - Adding the event package to your IOC application:
-----------------------------------------------------

(1) Add EVENT, GENERALTIME, and RESTORE or AUTOSAVE to configure/RELEASE and 
clean/rebuild configure.

(2) Link event libraries into your app by adding to xxxApp/src/Makefile:

   xxx_LIBS += evrSupport
   xxx_LIBS += generalTime
   xxx_LIBS += devMrfEr
   xxx_LIBS += mrfVme64x
   xxx_LIBS += restore or autosave

Note that the order of the above libraries is important.

(3) Add the following .dbd files to xxxApp/src/Makefile 
    or to xxxApp/src/xxxInclude.dbd:

   xxx_DBD += evrSupport.dbd
   xxx_DBD += devMrfEr.dbd
   xxx_DBD += dbRestore.dbd or autosave.dbd

(4) If you want a routine to run after the fiducial at 360hz by the evrTask,
    (which runs at epicsThreadPriorityHigh+1), register the routine in your
    initialization code:

	#include "registryFunction.h"
	#include "evrTime.h"
	static void fiducialRoutine(void) {
	... your 360hz logic here ...
	... to get the current or the one of the next 2 360hz patterns...
	    evrModifier_ta modifier_a;
	    epicsTimeStamp time_s;
	    unsigned long  patternStatus; /* see evrPattern.h for values */
	    int status = evrTimeGetFromPipeline(&time_s, 
		<evrTimeCurrent, evrTimeNext1, evrTimeNext2, evrTimeActive>,
		modifier_a, &patternStatus, 0,0,0);
	... use BEAMCODE, TIMESLOT macros defined in evrPattern.h ... 
	...   to parse out beam code and time slot from modifier_a ...
	... use PULSEID macro defined in evrTime.h ... 
	...   to parse out pulse ID from time_s ...
	... do your 360hz logic requiring pattern here ...
	}
	... in your init code ...
	evrTimeRegister((REGISTRYFUNCTION)fiducialRoutine);
	...

    See event/<release>/evrIoc/src/mpsEvrProc.c for an example.


(5) Add EVR databases to your application.  For an example, see:
	event/<release>/evrIoc/Db/evrXL05.substitutions

(6) Add pattern-related databases to your application.  For an example, see:
	event/<release>/evrIoc/Db/evrPatternXL05.substitutions

(7) For IOCs with triggered devices, add trigger databases to your application.
    For an example, see:
	event/<release>/evrIoc/Db/trigXL05.substitutions

(8) For IOCs with beam-synchronous acquisition (BSA), add BSA databases to 
    your application.  For an example, see:
	event/<release>/evrIoc/Db/bsaXL05.substitutions

(8a) For each record that is an input to BSA, add a forward-link (FLNK) to 
     record processing that occurs at beam or trigger time:
	  field(FLNK, "<dev>:EF<secn>")
     Consult with the HLA group to determine the proper values of <dev> and
     <secn> for your application.

(8b) If you prefer not to use the FLNK to provide input to BSA, use the
     API directly:

	#include "bsa.h"
	... your initialization logic - do at or before iocInit ....
	... for every value that BSA needs (ie, X,Y,TMIT for each device) ...
	char[PVNAME_STRINGSZ] bsaName = <BSA name for the data>
	void                 *dpvt = 0; /* unique per value */
	status = bsaSecnInit(bsaName, 0, &dpvt);

	... your data processing logic here ...
	... to update BSA after data is ready ...
	... for every value that BSA needs (ie, X,Y,TMIT for each device) ...
	epicsTimeStamp dataTimeStamp = <timestamp of your data>
	double         dataValue = <value of your data>
	epicsEnum16    dataSevr = <EPICS alarm severity of your data>
	void          *dpvt = <value of dpvt from bsaSecnInit>
	status = bsaSecnAvg(&dataTimeStamp, dataValue, dataSevr, dpvt);

(9) For IOCs with triggered devices, add setpoints to the proper 
    configuration file used to save and restore setpoints.  
    The setpoint PVs include:
	Per IOC:
	$(IOC):FIDUCIALRATE.HIHI /LOG
	$(IOC):FIDUCIALRATE.LOLO /LOG
	$(IOC):TREF /LOG
	Per triggered device:
	$(DEV)TDES
	$(DEV)TCON
	$(DEV)TWID /LOG
	$(DEV)TPOL /LOG
	$(DEV)TCTL /LOG

(9a) If the IOC is using ChannelWatcher to save setpoints, add the above 
     setpoints to the IOC's ChannelWatcher configuration file.  
     The .cwConfig file can be created from a .cwsubstitutions file.  
     For an example, see:
	event/<release>/evrIoc/srcRestore/trigXL05.cwsubstitutions

(10) For IOCs with triggered devices, add the trigger delays to the Channel
     Archiver.

(11) For IOCs with triggered devices which use event codes that are generated 
    at a "slow" rate (rate slower than beam full rate like a 10Hz event code), 
    if records for your devices process or finish processing 8.3 msec beyond
    the time of the trigger (ie, profile monitors), set the TSE field of those 
    records to the event code.  The records will then be timestamped at the
    time that the event code was received instead of the time of the last 
    fiducial.  The records can then be correlated with other records on other
    IOCs (ie, BPMs) that were acquired on the same pulse.  Make sure that
    the event code IRQ for all possible TSE values is enabled in your EVR
    database.

(12) Add each EVR to the following displays:
	$EDM/event/evnt_<loca>_main.edl
	and one of the following:
	$EDM/event/evnt_all_controllers.edl
	$EDM/event/evnt_all_beamDiag1.edl
	$EDM/event/evnt_all_beamDiag2.edl
	$EDM/event/evnt_all_laser.edl
	$EDM/event/evnt_all_profileMonitor.edl

(13) Add the following PVs to ALH under the "IOC" subgroup 
     of the "Event" subgroup for the applicable machine areas:
	For each IOC:
	<iocname>:PATTERNSTATE
	<iocname>:FIDUCIALRATE
	For each EVR:
	<evrname>:LINK

(14) Two global variables providing the high resolution time of the fiducial
     are available for diagnostics purposes:
	evrFiducialTime - high resolution time of the last fiducial 
			  (360hz update)
	evrActiveFiducialTime - high resolution time of the last 
                          timeslot 1 or 4 fiducial (120hz update)
     These values are also provided in <ioc>:FIDUCIAL.A and B, respectively.

II - Adding event databases and EVR configuration to your IOC startup file:
--------------------------------------------------------------------------

(1) If your IOC supports beam-synchronous acquisition, it will need to support
    large waveforms for channel access.  Add the following command 
    before iocInit:

    epicsEnvSet("EPICS_CA_MAX_ARRAY_BYTES", "32000")

    If your IOC already supports waveforms larger than 32000 bytes for other
    reasons, then this command is not needed. 

(2) Load databases created in the previous section (before iocInit).

(3) Add ErConfigure for each EVR before iocInit.

    VME:      ErConfigure(<instance>,<address>,<vector>,<level>,0)
    PMC:      ErConfigure(<instance>,    0    ,    0   ,   0   ,1)
    Embedded: ErConfigure(<instance>,    0    ,<vector>,<level>,2)

    where instance = EVR instance, starting from 0, incrementing by 1
                     for each subsequent card.  Only 1 EVR instance
		     is allowed for Embedded EVRs.
    and   address  = VME card address, starting from 0x300000, 
                     incrementing by 0x100000 for each subsequent card
                     (0 for PMC and Embedded)
    and   vector   = VME or Embedded interrupt vector.  
		     For VME, start from 0x60 and increment by 0x02 for 
		     each subsequent card.
                     (0 for PMC)
    and   level    = VME or Embedded interrupt level.
		     For VME, set to 4.  Can be the same for all EVRs.
                     (0 for PMC)
    and   0        = VME
       or 1        = PMC
       or 2	   = Embedded

(4) For IOCs with triggers, add a line to restore the trigger setpoints 
    before iocInit.  See the ChannelWatcher README file.

III - Hardware Setup:
---------------------

(1) Installation instructions for the PMC EVR are here:
    http://www.slac.stanford.edu/grp/lcls/controls/global/subsystems/timing/PMC-EVR_install_inst_v1d0.pdf

(2) For VME EVRs, at times, the white tab in the IEEE handle does not pop out
    all the way and the module blue light remains on and the module will not 
    configure.  Make sure the tab is out when seating the module.

(3) Connect fiber from a nearby timing fiber fanout module to each EVR.  These 
    fanout modules are identified in the timing system block diagram by 
    Mike Browne:
    https://sharepoint.slac.stanford.edu/sites/LCLS%20Document%20Storage/
    01%20-%20LCLS%20Systems/electronbeamsys/controls/Shared%20Documents/
    Timing/TIMING%20System%20BD.pdf

    If the fiber has just the receive cable, connect the single cable to the
    top spigot of the transceiver (bottom when the black lock is on the
    right).

IV - Special One-Time PMC Setup:
--------------------------------

The PMC EVRs, as delivered, have incorrect device and vendor IDs in their 
EEPROMs.  These IDs must be corrected before the module can be configured 
by the software.  Use the following one-time procedure to burn in the
correct values for each PMC EVR.  

WARNING - WARNING - WARNING:
IF THERE ARE OTHER PMCS CONNECTED TO YOUR CPU, IT'S POSSIBLE THIS
PROCEDURE WILL WRITE TO THE WRONG PMC AND RUIN IT!!  REMOVE 
NON-EVR PMCS BEFORE RUNNING THIS PROCEDURE TO BE SAFE.

(1) Boot the CPU with an IOC application that includes the event package.
    The "ErConfigure" command for each PMC EVR will fail if it hasn't yet 
    been corrected.

(2) Type the following command to read the vendor and device ID for 
    PMC instance 0 or 1:

    Cexp>evrEEPROMFixup(<0 or 1>,0)

    Look for these results:

    PLX 9030 found at 0xe110<0or1>000, EEPROM present
    Subsytem vendor ID 0x10b5, device ID 0x9030

    > Sanity check passed...
    > Informational mode only; EEPROM contents unmodified.
    ==> Call again with nonzero 'doit' argument to apply change.
    0x00000000 

(3) If the results are as expected, type the following command to correct
    the vendor and device ID:

    Cexp> evrEEPROMFixup(<0 or 1>,1)

    Look for these results:

    PLX 9030 found at 0xe110<0or1>000, EEPROM present
    Subsytem vendor ID 0x10b5, device ID 0x9030

    > Sanity check passed...
    > Writing MRF id (0x1a3e) to EEPROM SSVID
    > Writing EVR id (0x10c8) to EEPROM SSDID
    ==> EEPROM successfully fixed
    0x00000000 (0)

(4) Reboot the CPU and check that the ErConfigure commands are successful.

V - Checkout Instructions
-------------------------

(1) Errors when loading event databases, contact drogind.
(2) Errors from ErConfigure, contact saa.
(3) ErConfigure is successful but EVR has red LEDs, contact jedu to make 
sure your fiber is connected properly from EVG through fanout modules to
your EVR.
(4) Unexpected or ominous messages at your console, contact saa. 
(5) Once the IOC is up and configured successfully, type "dbcar()" at the 
Cexp prompt and make sure there are no disconnected channels.  Contact saa
if there are.
(6) From the home LCLS EDM display (lclshome) on a production machine, select 
"Event".  Under "EVR IOCs", select the button containing your IOC.  Select 
each display next to your IOC name (all channels must be connected):
  * EVR display - look for non-zero FPGA and "ON" for "Rx Link".
  * "Triggers..." display - check that all the event codes that you expect
    to use on your IOC are set.  Check that the proper channels are enabled
    for the proper event code(s).  If any records on your IOC use a non-zero
    TSE, check that the event codes used by your TSEs have the IRQ enabled.
  * "Events..." display - check that the rate for event code 1 is exactly 
    360Hz.  For event codes that have the IRQ set, check that their rates
    are as expected.
  * "Pattern..." display - check that data is changing every 2 seconds.  From 
    the main Event display, select "EVG Diags...".  
    The data on your EVR pattern display and the EVG pattern display must 
    match.  If the pattern data is all magenta, the fiber to your EVR is 
    probably not connected properly.  Select "General Time" and check that
    the "Best Time Event Provider" is evrTimeGet.
  * "Devices..." display - check that all your triggered devices are 
    available and the polarity, pulse width, delay (TDES), and control (TCTL)
    are properly set.
  * Contact saa if any problem.
(7) If the timestamps of your records are not reasonable, contact saa.
(8) Check that the polarity, pulse width, delay, and control of your devices
    are being monitored and updated by your IOC's ChannelWatcher and are 
    properly restored on reboot.
(9) Check that the Channel Archiver is recording all your trigger delays and
    that there are no disconnected channels.
